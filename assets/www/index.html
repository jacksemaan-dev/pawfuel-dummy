<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Keep charset first so emojis & text render correctly -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Make all relative links resolve against this file in WKWebView -->
  <base href="./">

  <!-- Optional but helpful CSP while loading local assets -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: blob:;
                 img-src 'self' data: blob:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self' data: blob:;
                 font-src 'self' data: blob:;
                 media-src 'self' data: blob:">

  <meta name="theme-color" content="#1a1a1a">
  <title>PawFuel</title>

  <!-- Local assets (must exist under assets/www/) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./style.css">

  <!-- Disable SW when running from flutter-asset:// or file:// -->
  <script>
    (function () {
      try {
        var isHttp = /^https?:$/i.test(location.protocol);
        if (!isHttp && 'serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations()
            .then(rs => rs.forEach(r => r.unregister()))
            .catch(() => {});
          try { navigator.serviceWorker.register = function(){ return Promise.resolve({}); }; } catch(e){}
        }
        // Surface JS errors
        window.addEventListener('error', function(e){
          try { console.error('[ASSET-ERROR]', e.message, e.filename, e.lineno); } catch(_) {}
        });
      } catch (e) {}
    })();
  </script>

  <!-- Optional autoload for split bundles (kept, but paths normalized) -->
  <script>
    (function () {
      try {
        function addCss(href) {
          var l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = href;
          document.head.appendChild(l);
        }
        function addJs(src) {
          return new Promise(function (res, rej) {
            var s = document.createElement('script');
            s.src = src;
            s.onload = res;
            s.onerror = function(){ console.error('[AUTOLOAD] fail', src); rej(new Error('load '+src)); };
            document.body.appendChild(s);
          });
        }
        function seq(list){ return list.reduce((p,src)=>p.then(()=>addJs(src)), Promise.resolve()); }

        fetch('./autoload_manifest.json')
          .then(r => r.ok ? r.json() : Promise.reject(r.status))
          .then(function (m) {
            try {
              (m.css || []).forEach(function (p) {
                if (p && !/^https?:/i.test(p)) addCss('./' + p.replace(/^\.?\//, ''));
              });
              var js = (m.js || [])
                .filter(p => p && !/^https?:/i.test(p))
                .map(p => './' + p.replace(/^\.?\//, ''));
              return seq(js);
            } catch (e) { console.error('[AUTOLOAD] error', e); }
          })
          .catch(function (e) { console.error('[AUTOLOAD] manifest error', e); });
      } catch (e) { console.error('[AUTOLOAD] fatal', e); }
    })();
  </script>
</head>

<body>
  <div id="app">
    <!-- Navigation -->
    <nav id="navBar">
      <button data-page="home"><span class="paw-icon">üêæ</span><span class="nav-label">Home</span></button>
      <button data-page="inventory"><span class="paw-icon">üì¶</span><span class="nav-label">Inventory</span></button>
      <button data-page="stool"><span class="paw-icon">üí©</span><span class="nav-label">Stool</span></button>
      <button data-page="plates"><span class="paw-icon">üçΩÔ∏è</span><span class="nav-label">Plates</span></button>
      <button data-page="insights"><span class="paw-icon">üìä</span><span class="nav-label">Insights</span></button>
      <button data-page="orders"><span class="paw-icon">üßæ</span><span class="nav-label">Orders</span></button>
      <button data-page="settings"><span class="paw-icon">‚öôÔ∏è</span><span class="nav-label">Settings</span></button>
      <button data-page="account"><span class="paw-icon">üë§</span><span class="nav-label">Account</span></button>
    </nav>

    <!-- Pages -->
    <main id="pages">
      <section id="homePage" class="page hidden">
        <div class="hero">
          <h1>PawFuel</h1>
          <p id="motto">Fuel them like nature intended</p>
        </div>
        <div id="mealCard" class="card"></div>
        <div id="coachCard" class="card"></div>
      </section>

      <section id="inventoryPage" class="page hidden">
        <h2>Inventory</h2>
        <div id="inventoryList"></div>
        <button id="addStockBtn" class="primary">Add Stock</button>
        <button id="addProductBtn" class="secondary">Add Product</button>
      </section>

      <section id="stoolPage" class="page hidden">
        <h2>Stool Analysis</h2>
        <div id="stoolResult" class="card"></div>
        <label for="stoolInput" class="primary">Analyse Stool Photo
          <input id="stoolInput" type="file" accept="image/*" style="display:none">
        </label>
      </section>

      <section id="platesPage" class="page hidden">
        <h2>Plates Tutorials</h2>
        <div id="platesList"></div>
      </section>

      <section id="insightsPage" class="page hidden">
        <h2>Insights</h2>
        <div id="insightsContent"></div>
      </section>

      <section id="ordersPage" class="page hidden">
        <h2>Orders</h2>
        <div id="ordersContent"></div>
        <button id="orderBtn" class="primary">Copy Order List</button>
      </section>

      <section id="settingsPage" class="page hidden">
        <h2>Settings</h2>
        <div id="settingsContent"></div>
      </section>

      <section id="accountPage" class="page hidden"></section>
      <section id="onboardingPage" class="page hidden"></section>
      <section id="faqsPage" class="page hidden"><h2>FAQs</h2><div id="faqsContent"></div></section>
      <section id="studiesPage" class="page hidden"><h2>Studies</h2><div id="studiesContent"></div></section>
    </main>
  </div>

  <!-- Local scripts (must exist under assets/www/) -->
  <script src="./assets/embedded_catalog.js"></script>
  <script src="./app.js"></script>
</body>
</html>
