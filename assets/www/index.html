<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <base href="./">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PawFuel</title>
  <link rel="stylesheet" href="./style.css">

  <!-- Inline fallback for env.json (ONLY used if XHR fails or returns empty) -->
  <script id="__inline_env_json" type="application/json">
  {
    "env": "staging",
    "billingStartAt": "2025-10-01",
    "pricing": {
      "user":   { "monthly": 1.99, "yearly": 18.00 },
      "shop":   { "monthly": 10.00, "yearly": 90.00 },
      "commissionPercent": 3
    },
    "loyalty": {
      "eligibleIfJoinedBefore": "2025-10-01",
      "discountPercent": 50,
      "months": 3
    }
  }
  </script>

  <!-- Robust fetch shim for WKWebView local file:// assets -->
  <script>
  (function () {
    try {
      if (location.protocol !== 'file:') return; // only patch local-asset mode
      var origFetch = typeof window.fetch === 'function' ? window.fetch.bind(window) : null;

      function resolveUrl(u) {
        var raw = (typeof u === 'string') ? u : (u && u.url) || '';
        return new URL(raw || '.', document.baseURI).href;
      }
      function inlineEnvResponse() {
        var node = document.getElementById('__inline_env_json');
        var text = node ? (node.textContent || '') : '';
        console.log('DBG: env source INLINE');
        return new Response(text, { status: 200, headers: new Headers({ 'Content-Type': 'application/json' }) });
      }
      function xhrFetch(resolved, init, isEnvJson) {
        return new Promise(function (resolve, reject) {
          try {
            var xhr = new XMLHttpRequest();
            xhr.open((init && init.method) || 'GET', resolved, true);
            xhr.responseType = 'text';
            try { xhr.overrideMimeType('application/json'); } catch (_) {}
            if (init && init.headers) {
              try { Object.keys(init.headers).forEach(function (k) { try { xhr.setRequestHeader(k, init.headers[k]); } catch (_) {} }); } catch (_) {}
            }
            xhr.onload = function () {
              var status = (xhr.status === 0) ? 200 : xhr.status;
              var body = xhr.responseText || '';
              if (isEnvJson) {
                if (body && body.length > 0) {
                  console.log('DBG: env source XHR', resolved);
                  return resolve(new Response(body, { status: status, headers: new Headers({ 'Content-Type': 'application/json' }) }));
                }
                return resolve(inlineEnvResponse());
              }
              resolve(new Response(body, { status: status, headers: new Headers({ 'Content-Type': 'text/plain' }) }));
            };
            xhr.onerror = function () { if (isEnvJson) return resolve(inlineEnvResponse()); reject(new TypeError('Local file load failed')); };
            xhr.send((init && init.body) || null);
          } catch (e) { reject(e); }
        });
      }
      window.fetch = function (input, init) {
        try {
          var url = (typeof input === 'string') ? input : (input && input.url) || '';
          if (/^https?:/i.test(url)) { return origFetch ? origFetch(input, init) : Promise.reject(new Error('fetch unavailable')); }
          var resolved = resolveUrl(input);
          var isEnvJson = /(^|\/)Configs\/env\.json(\?|#|$)/i.test(resolved) || /(^|\/)env\.json(\?|#|$)/i.test(resolved);
          return xhrFetch(resolved, init, isEnvJson);
        } catch (_) { return origFetch ? origFetch(input, init) : Promise.reject(new Error('fetch unavailable')); }
      };
    } catch (e) { /* no-op */ }
  })();
  </script>

  <style>
    /* Safe-boot: make pages hidden by default; JS shows selected one */
    .page{display:none}
    nav{user-select:none}
    nav button{margin:.15rem .25rem; padding:.4rem .6rem}
    #pricing .plan, #pricing .loyalty, .free-until{margin:.35rem 0}
  </style>
</head>
<body>
  <div id="canary" class="canary">Build Canary v12</div>

  <nav id="nav">
    <!-- navigation buttons; labels will be injected via JS -->
    <button data-section="home"></button>
    <button data-section="inventory"></button>
    <button data-section="stool"></button>
    <button data-section="plates"></button>
    <button data-section="insights"></button>
    <button data-section="orders"></button>
    <button data-section="settings"></button>
    <button data-section="account"></button>
    <button data-section="onboarding"></button>
    <button data-section="faqs"></button>
    <button data-section="studies"></button>
    <button data-section="shop"></button>
    <button id="lang-toggle"></button>
  </nav>

  <div id="content">
    <section id="home" class="page">Welcome to PawFuel.</section>
    <section id="inventory" class="page">Inventory page.</section>
    <section id="stool" class="page">Stool page.</section>
    <section id="plates" class="page">Plates page.</section>
    <section id="insights" class="page">Insights page.</section>
    <section id="orders" class="page">
      <h2>Orders</h2>
      <div id="orders-list"></div>
      <div class="order-form">
        <label><span id="label-order-subtotal">Order Subtotal:</span>
          <input type="number" id="order-subtotal" min="0" step="0.01">
        </label>
        <button id="create-order"></button>
      </div>
      <div id="order-result"></div>
      <button id="download-pdf"></button>
    </section>
    <section id="settings" class="page">Settings page.</section>
    <section id="account" class="page">Account page.</section>
    <section id="onboarding" class="page">Onboarding page.</section>
    <section id="faqs" class="page">FAQs page.</section>
    <section id="studies" class="page">Studies page.</section>
    <section id="shop" class="page">
      <h2 id="shop-portal-title">Shop Owner Portal</h2>
      <div id="shop-signup">
        <input type="file" id="catalog-upload" accept="application/json,application/xml,image/*">
        <button id="upload-catalog"></button>
        <div id="upload-status"></div>
      </div>
    </section>
    <section id="pricing" class="page">
      <h2 id="pricing-title">Pricing</h2>
      <div id="pricing-content"></div>
    </section>
  </div>

  <!-- DEBUG OVERLAY (temporary) -->
  <div id="__dbg" style="position:fixed;bottom:0;left:0;right:0;max-height:40%;
    overflow:auto;background:rgba(0,0,0,.85);color:#0f0;font:12px/1.4 monospace;
    padding:6px;z-index:99999;white-space:pre-wrap;display:block;">
    [DBG] overlay active…
  </div>
  <script>
  (function(){
    try {
      var box = document.getElementById('__dbg');
      function pfx(k){ return '['+new Date().toISOString().slice(11,19)+'] '+k+': '; }
      var _log = console.log, _err = console.error, _warn = console.warn;
      console.log = function(){ try{ box.textContent += "\n"+pfx('LOG')+Array.from(arguments).join(' ');}catch(_){}; _log.apply(console, arguments); };
      console.warn = function(){ try{ box.textContent += "\n"+pfx('WARN')+Array.from(arguments).join(' ');}catch(_){}; _warn.apply(console, arguments); };
      console.error = function(){ try{ box.textContent += "\n"+pfx('ERR')+Array.from(arguments).join(' ');}catch(_){}; _err.apply(console, arguments); };
      window.addEventListener('error', function(e){
        try{ box.textContent += "\n"+pfx('ONERROR')+e.message+" @ "+e.filename+":"+e.lineno; }catch(_){}
      });

      var testUrl = new URL('./Configs/env.json', document.baseURI).href;
      console.log('DBG: baseHref=', (document.querySelector('base')||{}).href);
      console.log('DBG: resolved env url', testUrl);

      fetch(testUrl)
        .then(function(r){ console.log('DBG: env status', r.status); return r.text(); })
        .then(function(t){ console.log('DBG: env length', t.length); })
        .catch(function(e){ console.error('DBG: env fetch failed', e && (e.message||e)); });

    } catch(e){ /* swallow */ }
  })();
  </script>

  <!-- SAFE-BOOT UI: if app.js misses, we still get a working UI -->
  <script>
  (function(){
    function log(){ try{ console.log.apply(console, arguments); }catch(_){ } }
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
    function setText(el, t){ if(el) el.textContent = t; }
    function show(id){ $all('.page').forEach(s => s.style.display = (s.id===id?'block':'none')); }

    function initNav(){
      const labels = {home:'Home',inventory:'Inventory',stool:'Stool',plates:'Plates',insights:'Insights',orders:'Orders',settings:'Settings',account:'Account',onboarding:'Onboarding',faqs:'FAQs',studies:'Studies',shop:'Shop Owner'};
      Object.keys(labels).forEach(id=>{
        const btn = document.querySelector('button[data-section="'+id+'"]');
        if(btn){ setText(btn, labels[id]); btn.onclick = () => show(id); }
      });
      const lang = $('#lang-toggle'); if(lang) setText(lang, 'عربية');
    }

    function renderPricing(cfg){
      const box = $('#pricing-content'); if(!box) return;
      const p = cfg.pricing || {}, u = p.user || {}, s = p.shop || {};
      const commission = (p.commissionPercent!=null ? p.commissionPercent : 3);
      const bsa = cfg.billingStartAt ? new Date(cfg.billingStartAt) : null;

      const lines=[];
      if (bsa) lines.push('<div class="free-until">Free until '+ bsa.toLocaleDateString() +'</div>');
      lines.push('<div class="plan"><b>Users</b>: $'+ (u.monthly||1.99).toFixed(2) +'/mo · $'+ (u.yearly||18).toFixed(2) +'/yr</div>');
      lines.push('<div class="plan"><b>Shop owners</b>: $'+ (s.monthly||10).toFixed(2) +'/mo · $'+ (s.yearly||90).toFixed(2) +'/yr</div>');
      lines.push('<div class="plan"><b>Commission</b>: '+ commission +'%</div>');

      const loy = cfg.loyalty || {};
      if (loy.discountPercent && loy.months && loy.eligibleIfJoinedBefore){
        const d = new Date(loy.eligibleIfJoinedBefore);
        lines.push('<div class="loyalty">Early adopters: '+loy.discountPercent+'% off first '+loy.months+' paid months (joined before '+ d.toLocaleDateString() +').</div>');
      }

      box.innerHTML = lines.join('');
    }

    function safeInit(){
      if (window.__pawfuel_ready) { log('DBG: safe boot not needed'); return; }
      log('DBG: safe boot INIT');
      initNav();
      show('pricing');
      fetch('./Configs/env.json')
        .then(r=>r.json())
        .then(cfg=>{ window.__pawfuel_safe_cfg = cfg; renderPricing(cfg); })
        .catch(e=>{ console.error('DBG: safe boot env error', e); });
    }

    document.addEventListener('DOMContentLoaded', ()=> setTimeout(safeInit, 120));
    setTimeout(safeInit, 2200); // watchdog if DOMContentLoaded missed
  })();
  </script>

  <!-- App script (local) -->
  <script src="./app.js"></script>
</body>
</html>
